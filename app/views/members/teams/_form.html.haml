= simple_nested_form_for @group, url: project_team_path(@project), html: { class: 'widget-form' } do |f|
  = f.error_notification
  = f.input :full_name, label: 'Name'
  = f.input :user_name, label: 'Pretty URL'
  %table#sortable.table.table-condensed
    %thead
      %th User
      %th Permission
      %th Status
      %th
    %tbody
      - (@group.members.includes(:user).sort_by{|m| m.user.name } + [@group.members.new]).each do |member|
        = f.simple_fields_for :members, member, wrapper: false do |f_member|
          %tr.fields
            - if member.persisted?
              %td= member.user.name
            - else
              %td
                = f_member.association :user, collection: User.invitation_accepted_or_not_invited.sort_by{|u| u.name }, label: false
            = f_member.simple_fields_for :permission do |f_perm|
              %td= f_perm.input :action, collection: Permission::ACTIONS, label: false
            %td
              - if member.persisted?
                - if member.invitation_pending?
                  - if member.user.invited_to_sign_up?
                    Pending sign up
                  - else
                    Invitation pending
                - else
                  Member
              - else
                Not saved
            %td= f_member.link_to_remove content_tag(:i, '', class: 'fa fa-trash-o'), class: 'btn btn-sm btn-danger'
      %tr.sortable-disabled
        %td{ colspan: 4 }= f.link_to_add 'Add a member', :members, class: 'btn btn-xs btn-success'
  -# %p.help-block
    Add users to manage your group.

  .form-actions
    = f.submit 'Save changes', class: 'btn btn-primary'
    = link_to 'Cancel', @project, class: 'btn btn-link btn-sm'


= content_for :js do
  :javascript
    jQuery(function($) {
      window.NestedFormEvents.prototype.insertFields = function(content, assoc, link) {
        var $tr = $(link).closest('tr');
        content = content.replace(/^<div class="fields">/,"");
        content = content.replace(/<\/div>$/,"");
        return $(content).insertBefore($tr);
      }
    });