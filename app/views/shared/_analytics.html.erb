<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '<%= tracker %>']);
  _gaq.push(['_setDomainName', '<%= domain %>']);
  _gaq.push(['_trackPageview']);
  _gaq.push(['_setCustomVar', 1, 'User Type', '<%= user_signed_in? ? 'Member' : 'Visitor' %>', 2]);
  _gaq.push(['_setCustomVar', 1, 'Controller', '<%= self.controller_name %>', 3]);
  _gaq.push(['_setCustomVar', 2, 'Action', '<%= self.action_name %>', 3]);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<%- if defined?(track_outbound) and track_outbound %>
  <%= content_for :js do %>
    <%# moving it to :js so that $ is defined %>
    <script type="text/javascript">
      $(function() {
        $("body").on('click', 'a', function(e){
          var url = $(this).attr("href");
          if (e.currentTarget.host != window.location.host && url.indexOf('javascript:') == -1) {
            _gaq.push(['_trackEvent', 'Outbound Links', e.currentTarget.host.replace(':80', ''), url]);
            if (e.metaKey || e.ctrlKey || this.target == "_blank") {
              var newtab = true;
            }
            if (!newtab) {
              e.preventDefault();
              setTimeout('document.location = "' + url + '"', 100);
            }
          }
        });
        $('.project-switcher').on('click', function(e){
          var url = $(this).attr("href");
          var dir = url.match(/dir=([a-z]+)/)[1];
          _gaq.push(['_trackEvent', 'ProjectSwitcher', dir, url]);
          if (e.metaKey || e.ctrlKey) {
            var newtab = true;
          }
          if (!newtab) {
            e.preventDefault();
            setTimeout('document.location = "' + url + '"', 100);
          }
        });
      });
    </script>
  <% end %>
<% end %>